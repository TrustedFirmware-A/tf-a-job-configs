- job:
    name: "tf-a-tftf-gerrit-tforg-l2"
    node: "docker-amd64-tf-a-jammy"
    project-type: "multijob"
    concurrent: true
    disabled: false

    description: |
      Job that triggers for every TF-A-Tests patch approved with the Allow-CI+2
      label on review.trustedfirmware.org.

    properties:
      - "tf-a-clone-properties"

      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a"

      - throttle:
          option: "project"
          enabled: true
          max-total: 5

      - build-discarder:
          days-to-keep: 14

    parameters:
      - tf-a-clone-parameters:
          projects: "trusted-firmware-a,tf-a-ci-scripts,tf-a-tests,tf-m-extras,tf-m-tests,tf-rmm,spm"

      - string:
          name: "GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/tf-a-tests"

      - string:
          name: "GERRIT_BRANCH"
          default: "master"

      - string:
          name: "GERRIT_REFSPEC"
          default: "master"

      - string:
          name: "GERRIT_PATCHSET_NUMBER"
          default: ""

      - string:
          name: "GERRIT_CHANGE_NUMBER"
          default: ""

      - string:
          name: "TF_GERRIT_BRANCH"
          default: "master"
          description: "Git project branch for Trusted Firmware-A."

      - string:
          name: "TF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "master"
          description: "Git refspec for Trusted Firmware-A."

      - string:
          name: "TFTF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/tf-a-tests"

      - string:
          name: "TFTF_GERRIT_REFSPEC"
          default: "${{GERRIT_REFSPEC}}"
          description: "Parameter only used by the clone script"

      - string:
          name: "SPM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}hafnium/hafnium"

      - string:
          name: "SPM_REFSPEC"
          default: "master"

          description: |
            SPM (Hafnium) refspec to use.

      - string:
          name: "RMM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-RMM/tf-rmm"

      - string:
          name: "RMM_REFSPEC"
          default: "main"

          description: |
            tf-rmm refspec to use. The main branch is used by default.

      - string:
          name: "CI_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-ci-scripts"

      - string:
          name: "CI_REFSPEC"
          default: "master"

      - string:
          name: "JOBS_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-job-configs.git"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "MBEDTLS_URL"
          default: "https://github.com/Mbed-TLS/mbedtls/archive/mbedtls-3.6.5.tar.gz"

    wrappers:
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - "timestamps"

    builders:
      - tf-a-clone:
          projects: "${{CLONE_REPOS}}"

      - shell: |
          #!/bin/bash
          set -e
          cat << EOF > env.param
          GERRIT_PATCHSET_NUMBER=${{GERRIT_PATCHSET_NUMBER}}
          GERRIT_CHANGE_NUMBER=${{GERRIT_CHANGE_NUMBER}}
          GERRIT_HOST=${{GERRIT_HOST}}
          TFTF_GERRIT_PROJECT=${{GERRIT_PROJECT}}
          TFTF_GERRIT_BRANCH=${{GERRIT_BRANCH}}
          TFTF_GERRIT_REFSPEC=${{GERRIT_REFSPEC}}
          EOF

      - multijob:
          condition: "COMPLETED"
          name: "Carry out level 1 tests"

          projects:
            - kill-phase-on: "NEVER"
              name: "tf-a-tftf-gerrit-tforg-l1"
              current-parameters: true
              property-file: "env.param"

      - multijob:
          condition: "COMPLETED"
          name: "Run Firmware Update Tests"

          projects:
            - kill-phase-on: "NEVER"
              name: "tf-a-ci-gateway"
              current-parameters: true

              predefined-parameters: |-
                TEST_GROUPS=tftf-l2-fwu

              property-file: "env.param"

      - multijob:
          condition: "COMPLETED"
          name: "Run Level 2 testing of TF-A-Tests"

          projects:
            - kill-phase-on: "NEVER"
              name: "tf-a-ci-gateway"
              current-parameters: true

              predefined-parameters: |-
                TEST_GROUPS=tftf-l2-fvp-auxiliary tftf-l2-juno tf-l2-boot-tests-spm-mm tftf-l2-fvp-dynamiq spm-l2-boot-tests

              property-file: "env.param"

      - multijob:
          condition: "COMPLETED"
          name: "Run extensive TF-A-Tests"

          projects:
            - kill-phase-on: "NEVER"
              name: "tf-a-ci-gateway"
              current-parameters: true

              predefined-parameters: |-
                TEST_GROUPS=tftf-l2-extensive-tests-fvp

              property-file: "env.param"

    triggers:
      - gerrit:
          server-name: "review.trustedfirmware.org"

          projects:
            - branches:
                - branch-compare-type: "PLAIN"
                  branch-pattern: "master"

              project-compare-type: "PLAIN"
              project-pattern: "{gerrit_project_prefix}TF-A/tf-a-tests"

          trigger-on:
            - comment-added-event:
                approval-category: "Allow-CI"
                approval-value: 2

          override-votes: true
          gerrit-build-started-verified-value: 0
          gerrit-build-successful-verified-value: 1
          gerrit-build-failed-verified-value: -1
          gerrit-build-unstable-verified-value: -1
          gerrit-build-notbuilt-verified-value: 0
          gerrit-build-started-codereview-value: 0
          gerrit-build-successful-codereview-value: 0
          gerrit-build-failed-codereview-value: 0
          gerrit-build-unstable-codereview-value: 0
          gerrit-build-notbuilt-codereview-value: 0
