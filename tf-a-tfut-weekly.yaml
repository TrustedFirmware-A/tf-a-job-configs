- job:
    name: "tf-a-tfut-weekly"
    node: "docker-amd64-tf-a-jammy"
    project-type: "multijob"
    concurrent: true
    disabled: false
    description: "CI job for weekly runs of TF-A Unit Testing"

    properties:
      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a"

      - throttle:
          option: "project"
          enabled: true
          max-total: 5

      - build-discarder:
          days-to-keep: 14
          num-to-keep: 60

    parameters:
      - tf-a-clone-parameters:
          projects: "trusted-firmware-a,tf-a-ci-scripts,tf-a-tests,tf-m-extras,tf-m-tests,tf-rmm,spm"

      - string:
          name: "GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "GERRIT_REFSPEC"
          default: "master"

      - string:
          name: "TF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "TF_GERRIT_BRANCH"
          default: "master"

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "master"

      - string:
          name: "TFTF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/tf-a-tests"

      - string:
          name: "TFTF_GERRIT_BRANCH"
          default: "master"

      - string:
          name: "TFTF_GERRIT_REFSPEC"
          default: "master"

      - string:
          name: "SPM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}hafnium/hafnium"

      - string:
          name: "SPM_REFSPEC"
          default: "master"

          description: |
            SPM(Hafnium) refspec to use. The master branch is used by default.

      - string:
          name: "RMM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-RMM/tf-rmm"

      - string:
          name: "RMM_REFSPEC"
          default: "main"

          description: |
            tf-rmm refspec to use. The main branch is used by default.

      - string:
          name: "TFUT_GERRIT_REFSPEC"
          default: "main"

          description: |
            tf-a-unit-tests refspec to use. The main branch is used by default.

      - string:
          name: "CI_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-ci-scripts"

      - string:
          name: "CI_REFSPEC"
          default: "master"

      - string:
          name: "JOBS_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-job-configs.git"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "LAVA_PRIORITY"
          default: "low"

      - string:
          name: "MBEDTLS_URL"
          default: "https://github.com/Mbed-TLS/mbedtls/archive/mbedtls-3.6.5.tar.gz"

      - string:
          name: "LAVA_RETRIES"
          default: 2

          description: |
            Number of tries submitting job to LAVA in case it fails (stopgap measure against nondeterministic failures)

      - string:
          name: "USE_TUXSUITE_FVP"
          default: 1

          description: |
            Whether to submit FVP tests via TuxSuite (instead of LAVA)

    wrappers:
      - "timestamps"

    builders:
      - tf-a-clone:
          projects: "${{CLONE_REPOS}}"

      - shell: |
          #!/bin/bash
          set -e
          cat << EOF > tf-a-env.param
          GERRIT_PROJECT=${{TF_GERRIT_PROJECT}}
          GERRIT_BRANCH=${{TF_GERRIT_BRANCH}}
          GERRIT_REFSPEC=${{TF_GERRIT_REFSPEC}}
          EOF
          cat << EOF > tf-a-tests-env.param
          GERRIT_PROJECT=${{TFTF_GERRIT_PROJECT}}
          GERRIT_BRANCH=${{TFTF_GERRIT_BRANCH}}
          GERRIT_REFSPEC=${{TFTF_GERRIT_REFSPEC}}
          EOF

      - multijob:
          name: "TFA UNIT TESTS"
          condition: "COMPLETED"

          projects:
            - name: "tf-a-ci-gateway"
              alias: "tfut"
              current-parameters: true
              kill-phase-on: "NEVER"
              predefined-parameters: "TEST_GROUPS=tfut"
              property-file: "tf-a-tests-env.param"

    triggers:
      - timed: "59 23 * * 7"
