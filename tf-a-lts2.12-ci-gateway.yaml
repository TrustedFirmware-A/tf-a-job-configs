- job:
    name: "tf-a-lts2.12-ci-gateway"
    node: "docker-amd64-tf-a-lts2.12-jammy"
    project-type: "freestyle"
    concurrent: true
    disabled: false

    description: |
      Main job entry point for a Trusted Firmware A (TF-A) LTS v2.12 CI.

    properties:
      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a-lts-v2.12"

      - build-discarder:
          days-to-keep: 15

      - throttle:
          option: "project"
          enabled: true
          max-per-node: 3
          max-total: 10

    wrappers:
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - timeout:
          timeout: 240
          fail: true

      - "timestamps"

    parameters:
      - tf-a-clone-parameters:
          projects: "trusted-firmware-a,tf-a-ci-scripts,tf-a-tests,tf-m-extras,tf-m-tests,tf-rmm,spm"

      - string:
          name: "GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "GERRIT_REFSPEC"
          default: "lts-v2.12"

      - string:
          name: "TEST_GROUPS"
          default: "tf-l2-boot-tests-cortex/fvp-default:fvp-linux-dtb-fip.uboot-cortexa35x4-debug"

          description: |
            White space separated list of test configs: can be mix of specific
            test configs (e.g., <code>l1/fvp-default:fvp-linux-default</code>) and
            group names (e.g., <code>l1 l2</code>).

      - string:
          name: "TF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "lts-v2.12"

          description: |
            trusted-firmware-a refspec to use. The lts-v2.12 branch is used by default.

      - string:
          name: "TFTF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/tf-a-tests"

      - string:
          name: "TFTF_GERRIT_REFSPEC"
          default: "lts-v2.12"

          description: |
            tf-a-tests refspec to use. The lts-v2.12 branch is used by default.

      - string:
          name: "TF_M_TESTS_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-M/tf-m-tests"

      - string:
          name: "TF_M_TESTS_GERRIT_REFSPEC"
          default: "53ddc58dcd57e1f5cf658b316d7d735335d58570"

          description: |
            tf-m-tests refspec to use. The tfa_ci_dep_revision branch is used by default.

      - string:
          name: "TF_M_EXTRAS_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-M/tf-m-extras"

      - string:
          name: "TF_M_EXTRAS_GERRIT_REFSPEC"
          default: "3ff04e40ff7f66c8cee087b6e5cbd8fb8c1bec01"

          description: |
            tf-m-extras refspec to use. The tfa_ci_dep_revision branch is used by default.

      - string:
          name: "SPM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}hafnium/hafnium"

      - string:
          name: "SPM_REFSPEC"
          default: "v2.12"

          description: |
            SPM(Hafnium) refspec to use. The 'v2.12' tag is used by default.

      - string:
          name: "CI_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-ci-scripts"

      - string:
          name: "CI_REFSPEC"
          default: "lts-v2.12"

          description: |
            tf-a-ci-scripts refspec to use. The lts-v2.12 branch is used by default.

      - string:
          name: "JOBS_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-job-configs.git"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - bool:
          name: "ENABLE_STATIC_CHECK"
          default: false

      - string:
          name: "QA_TOOLS_REPO"
          default: "https://git.gitlab.arm.com/tooling/qa-tools.git"

      - string:
          name: "QA_TOOLS_BRANCH"
          default: "master"

      - string:
          name: "USE_TUXSUITE_FVP"
          default: 1

          description: |
            Whether to submit FVP tests via TuxSuite (instead of LAVA)

    scm:
      - git:
          url: "ssh://review.trustedfirmware.org:29418/ci/tf-a-ci-scripts"
          credentials-id: "TFA_CI_BOT_USER_SSH_KEY"
          basedir: "tf-a-ci-scripts"

          refspec: "${{CI_REFSPEC}}"
          branches: ["master"]

          extensions:
            - choosing-strategy: "gerrit"
            - honor-refspec: true

    builders:
      - shell: |
          #!/bin/bash
          set -e
          CI_ROOT=${{PWD}}/tf-a-ci-scripts
          export workspace=$PWD
          export test_groups=$TEST_GROUPS
          $CI_ROOT/script/gen_test_desc.py

      - trigger-builds:
          - project:
              - "tf-a-lts2.12-builder"

            block: true
            current-parameters: true

            predefined-parameters: |
                CLONE_REPOS=${{CLONE_REPOS}}

            parameter-factories:
              - factory: "filebuild"
                file-pattern: "*.testprop"
                no-files-found-action: "FAIL"

    publishers:
      - postbuildscript:
          builders:
            - role: "SLAVE"

              build-on:
                - "SUCCESS"
                - "FAILURE"
                - "UNSTABLE"
                - "ABORTED"
                - "NOT_BUILT"

              build-steps:
                - shell: |-
                    #!/bin/bash -e
                    export CI_ROOT=${{PWD}}/tf-a-ci-scripts
                    bash "$CI_ROOT/job/tf-ci-gateway/generate_report.sh"

      - archive:
          artifacts: "report.json, report.html, merge/outdir/**"

      - groovy-postbuild:
          script: !include-raw-verbatim:
            - "tf-a-ci-gateway/postbuild.groovy"
