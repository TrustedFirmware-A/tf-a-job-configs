- job:
    name: "rf-a-unsafe"
    node: "docker-amd64-tf-a-jammy"
    project-type: "freestyle"
    concurrent: true
    disabled: false
    description: "Check for Unsafe changes in Rusted Firmware A"

    properties:
      - build-discarder:
          days-to-keep: 14

    triggers:
      - gerrit:
          server-name: "review.trustedfirmware.org"

          projects:
            - branches:
                - branch-compare-type: "PLAIN"
                  branch-pattern: "main"

              project-compare-type: "PLAIN"
              project-pattern: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

          trigger-on:
            - patchset-created-event:
                exclude-drafts: true
                exclude-trivial-rebase: true
                exclude-no-code-change: true
                exclude-private: true
                exclude-wip: true

            - comment-added-contains-event:
                comment-contains-value: "^RUN_UNSAFE_CI$"

          override-votes: false
          silent: true

    parameters:
      - tf-a-clone:
          projects: "tf-a-ci-scripts,rusted-firmware-a"

      # GERRIT_{PROJECT,BRANCH,REFSPEC} are set when triggered by a Gerrit
      # patchset - defaults below are for manual triggers
      - string:
          name: "GERRIT_PROJECT"
          default: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

      - string:
          name: "GERRIT_BRANCH"
          default: "main"

      - string:
          name: "GERRIT_REFSPEC"
          default: "main"

          description: |
            'e.g. refs/changes/13/31138/1'

      - string:
          name: "RFA_REFSPEC"
          default: "${{GERRIT_REFSPEC}}"

          description: |
            'do-not-amend: used by scripts/clone.sh to fetch the correct Gerrit patchset - use GERRIT_REFSPEC instead'

      - string:
          name: "CI_REFSPEC"
          default: "master"

          description: |
            'Refs to fetch for the tf-a-ci-scripts repo e.g. refs/changes/13/31138/1'

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

    wrappers:
      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a"

      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - "timestamps"

      - timeout:
          timeout: 240
          fail: true

    builders:
      - "tf-a-clone"

      - shell: |
          #!/bin/bash
          set -ex
          cat << EOF > tf-a-env.param
          RF_GERRIT_PROJECT=${{GERRIT_PROJECT}}
          RFA_REFSPEC=${{GERRIT_REFSPEC}}
          EOF

          cd ${{WORKSPACE}}/rusted-firmware-a

          git fetch --unshallow --update-shallow origin
          git fetch --unshallow --update-shallow origin ${{GERRIT_BRANCH}} ${{GERRIT_REFSPEC}}

          # Vote Unsafe-Review+1 on patches not touching any unsafe code

          # 1. Check if the patch touches unsafe code:

          # if the grep command finds nothing, it will exit 1 and because we have set -e the program
          # will fail. Doing || true makes it so that the final exit command is always 0 so the flow is not
          # interrupted and we can check `diff` to know if the program was successful or not.
          diff=$(echo $(git show -U10 --format= -- '*.rs' '*.S') | grep "unsafe" || true)
          if [ "$diff" != "" ]; then
              exit 1
          fi

          # 2. Cast the Unsafe-Review +1 vote if the patch does NOT touch unsafe code:

          SSH_PARAMS="-o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -o PubkeyAcceptedKeyTypes=+ssh-rsa -p 29418 -i ${{CI_BOT_KEY}}"
          GERRIT_URL="review.trustedfirmware.org"
          SET_SAFE_CMD="${{SSH_PARAMS}} ${{CI_BOT_USERNAME}}@${{GERRIT_URL}} gerrit review --label Unsafe-Review=1 -m Safe"
          ssh ${{SET_SAFE_CMD}} ${{GERRIT_CHANGE_NUMBER}},${{GERRIT_PATCHSET_NUMBER}}
