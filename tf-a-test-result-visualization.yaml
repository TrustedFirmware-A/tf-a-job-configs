- job:
    name: "tf-a-test-result-visualization"
    node: "docker-amd64-tf-a-jammy"
    project-type: "freestyle"
    concurrent: true
    description: "Generates a visualization of the test results from the current job."
    disabled: false

    properties:
      - build-discarder:
          days-to-keep: 14

    parameters:
      - string:
          name: "TF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "TF_GERRIT_BRANCH"
          default: "integration"

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "integration"

      - string:
          name: "TFTF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/tf-a-tests"

      - string:
          name: "TFTF_GERRIT_BRANCH"
          default: "master"

      - string:
          name: "TFTF_GERRIT_REFSPEC"
          default: "master"

      - string:
          name: "CI_REFSPEC"
          default: "master"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "TARGET_BUILD"
          default: "tf-a-main/1"
          description: "Target build to analyze."

    builders:
      - shell: !include-raw-verbatim: "scripts/clone.sh"

      - shell: |
          #!/bin/bash

          bash ${{WORKSPACE}}/tf-a-ci-scripts/script/graphs/tf-main-results.bash \
              "${{JENKINS_PUBLIC_URL}}job/${{TARGET_BUILD}}"

    publishers:
      - postbuildscript:
          builders:
            - role: "SLAVE"

              build-on:
                - "SUCCESS"
                - "FAILURE"
                - "UNSTABLE"
                - "ABORTED"
                - "NOT_BUILT"

              build-steps:
                - shell: |-
                    #!/bin/bash -e
                    export CI_ROOT=${{PWD}}/tf-a-ci-scripts
                    bash "$CI_ROOT/job/tf-ci-gateway/generate_report.sh" -t

      - archive:
          artifacts: "report.html, tf-a-main*.png, tf-a-main*.csv"

      - groovy-postbuild:
          script: !include-raw-verbatim:
            - "tf-a-ci-gateway/postbuild.groovy"
