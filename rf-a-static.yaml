- job:
    name: "rf-a-static"
    node: "docker-amd64-tf-a-jammy"
    project-type: "freestyle"
    concurrent: true
    disabled: false
    description: "Run formatting, static checks and lints"

    properties:
      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a"

      - build-discarder:
          days-to-keep: 14

    parameters:
      - tf-a-clone-parameters:
          projects: "tf-a-job-configs,tf-a-ci-scripts,rusted-firmware-a"

      - string:
          name: "RF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

      - string:
          name: "RFA_REFSPEC"
          default: "main"

          description: |
            rfa refspec to use. The main branch is used by default.

      - string:
          name: "GERRIT_BRANCH"
          default: "main"

      - string:
          name: "GERRIT_REFSPEC"
          default: "main"

      - string:
          name: "TF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "TF_GERRIT_BRANCH"
          default: "master"

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "master"

      - string:
          name: "CI_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-ci-scripts"

      - string:
          name: "CI_REFSPEC"
          default: "master"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "JOBS_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-job-configs.git"

    wrappers:
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - "timestamps"

      - timeout:
          timeout: 240
          fail: true

    builders:
      - "tf-a-clone"

      - shell: |
          #!/bin/bash
          set -e
          cat << EOF > env.param
          RFA_REFSPEC=${{RFA_REFSPEC}}
          GERRIT_REFSPEC=${{GERRIT_REFSPEC}}
          GERRIT_BRANCH=${{GERRIT_BRANCH}}
          EOF
          cd ${{WORKSPACE}}/rusted-firmware-a
          # Executed project-related static checks: copyright, unix line endings,
          # formatting and lints
          IS_CONTINUOUS_INTEGRATION=1 ${{WORKSPACE}}/tf-a-ci-scripts/script/next-checks/next-checks.sh

    publishers:
      - archive:
          artifacts: "rusted-firmware-a/next-checks.log"

      - groovy-postbuild:
          script: !include-raw-verbatim:
            - "rf-a-static/postbuild.groovy"
