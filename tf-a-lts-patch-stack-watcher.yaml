- job:
    name: "tf-a-lts-patch-stack-watcher"
    node: "docker-amd64-tf-a-jammy"
    project-type: "freestyle"
    concurrent: false
    description: "This job will trigger Allow-CI job whenever a new patch is created. It also monitors all patches, if submit requirement is met, it will merge the patch"
    disabled: false

    parameters:
      - bool:
          name: "ENABLE_PATCH_AUTO_SUBMISSION"

          description: |
            Enable patch auto submission function

          default: true

      - bool:
          name: "ENABLE_AUTO_ALLOW_CI_JOB"

          description: |
            Enable auto submit Allow-CI job

          default: true

      - string:
          name: "ALLOW_CI_JOB"

          description: |
            To trigger Allow-CI+1 or Allow-CI+2 job when a new patch is created

          default: "Allow-CI=2"

    builders:
      - shell: !include-raw-verbatim: "scripts/tf-a-lts-patch-stack-watcher.sh"

    properties:
      - build-discarder:
          days-to-keep: 60
          num-to-keep: 120

    triggers:
      - gerrit:
          silent: true
          server-name: "review.trustedfirmware.org"

          projects:
            - branches:
                - branch-compare-type: "REG_EXP"
                  branch-pattern: "lts-v.*"

              project-compare-type: "PLAIN"
              project-pattern: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

          trigger-on:
            - comment-added-event:
                approval-category: "Verified"
                approval-value: 1

            - comment-added-event:
                approval-category: "Code-Owner-Review"
                approval-value: 1

            - comment-added-event:
                approval-category: "Allow-CI"
                approval-value: 1

            - comment-added-event:
                approval-category: "Maintainer-Review"
                approval-value: 1

            - patchset-created-event:
                exclude-drafts: false
                exclude-trivial-rebase: false
                exclude-no-code-change: false
                exclude-private: false
                exclude-wip: false

    wrappers:
      - "timestamps"

      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""
