- job:
    name: "rf-a-crate-tzc-main"
    node: "docker-amd64-tf-a-jammy"
    project-type: "multijob"
    concurrent: true
    disabled: false
    description: "Main CI job for the arm-tzc crate"

    properties:
      - "tf-a-clone-properties"

      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a"

      - throttle:
          option: "project"
          enabled: true
          max-total: 5

      - build-discarder:
          days-to-keep: 14
          num-to-keep: 60

    parameters:
      - tf-a-clone-parameters:
          projects: "tf-a-ci-scripts,arm-tzc"

      # GERRIT_{PROJECT,BRANCH,REFSPEC} are set when triggered by a Gerrit
      # patchset - defaults below are for manual triggers
      - string:
          name: "GERRIT_PROJECT"
          default: "{gerrit_project_prefix}arm-firmware-crates/arm-tzc"

      - string:
          name: "GERRIT_BRANCH"
          default: "main"

      - string:
          name: "GERRIT_REFSPEC"
          default: "main"

          description: |
            'e.g. refs/changes/13/31138/1'

      - string:
          name: "ARM_TZC_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}arm-firmware-crates/arm-tzc"

      - string:
          name: "ARM_TZC_GERRIT_REFSPEC"
          default: "${{GERRIT_REFSPEC}}"

          description: |
            'do-not-amend: used by scripts/clone.sh to fetch the correct Gerrit patchset - use GERRIT_REFSPEC instead'

      - string:
          name: "CI_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-ci-scripts"

      - string:
          name: "CI_REFSPEC"
          default: "master"

          description: |
            'Refs to fetch for the tf-a-ci-scripts repo e.g. refs/changes/13/31138/1'

      - string:
          name: "JOBS_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-job-configs.git"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "TEST_FEATURES"
          description: "Features the arm-tzc crate will be tested against"

    wrappers:
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - "timestamps"

    builders:
      - shell: |
          #!/bin/bash
          set -e
          cat << EOF > tf-a-env.param
          ARM_TZC_GERRIT_PROJECT=${{GERRIT_PROJECT}}
          ARM_TZC_GERRIT_REFSPEC=${{GERRIT_REFSPEC}}
          EOF

      - multijob:
          name: "Platform independent tests"
          condition: "COMPLETED"

          projects:
            - name: "rf-a-crate-generic-lib-testing"
              current-parameters: true
              kill-phase-on: "NEVER"

              predefined-parameters: |
                TEST_REPO_NAME=arm-tzc
                TEST_REPO_PROJECT=arm-firmware-crates
                TEST_FEATURES=${{TEST_FEATURES}}

              property-file: "tf-a-env.param"
