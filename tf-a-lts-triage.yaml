- job:
    name: tf-a-lts-triage
    node: docker-amd64-tf-a-jammy
    project-type: freestyle
    concurrent: true
    disabled: true
    defaults: global
    description: |
      Job which triages incoming TF-A patches for suitability for LTS branch (https://linaro.atlassian.net/browse/TFC-395)
    properties:
        - build-discarder:
            days-to-keep: 45
            num-to-keep: 200
            artifact-num-to-keep: 100
        - authorization:
            !include: authorization.yaml.inc
    parameters:
        - string:
            name: GERRIT_HOST
            default: 'review.trustedfirmware.org'
        - string:
            name: GERRIT_PROJECT
            default: 'TF-A/trusted-firmware-a'
            description: |
              Git project to build (also set by Gerrit trigger)
        - string:
            name: GERRIT_BRANCH
            default: 'integration'
            description: |
              Git branch to build (also set by Gerrit trigger)
        - string:
            name: GERRIT_REFSPEC
            default: ''
    triggers:
    - gerrit:
        silent: true
        server-name: 'review.trustedfirmware.org'
        projects:
        - branches:
          - branch-compare-type: PLAIN
            branch-pattern: integration
          project-compare-type: PLAIN
          project-pattern: 'TF-A/trusted-firmware-a'
        trigger-on:
        - patchset-created-event
    wrappers:
    - timestamps
    - timeout:
        timeout: 30
        fail: true
    - credentials-binding:
      - ssh-user-private-key:
          credential-id: TFA_CI_BOT_USER_SSH_KEY
          key-file-variable: CI_BOT_KEY
          username-variable: CI_BOT_USERNAME
          passphrase-variable: ''
    builders:
    - shell: |
        #!/bin/bash
        set -ex
        env | grep GERRIT

        sudo apt-get update -q
        sudo apt-get install -y -q python3-git
        pip install unidiff>=0.7.4

        START_PATH=$(pwd)
        LTS_TMP_DIR=$(mktemp -d -p ./)
        cd $LTS_TMP_DIR

        git clone https://git.trustedfirmware.org/ci/tf-a-ci-scripts.git

        TFA_TMP_DIR=$(mktemp -d -p ./)
        cd $TFA_TMP_DIR
        git clone https://${GERRIT_HOST}/${GERRIT_PROJECT} -b ${GERRIT_BRANCH} ./
        if [ -n "${GERRIT_REFSPEC}" ]; then
        (
            # cd $(basename ${GERRIT_PROJECT})
            git fetch https://${GERRIT_HOST}/${GERRIT_PROJECT} ${GERRIT_REFSPEC} && git checkout FETCH_HEAD
            git checkout -b to_check
        )
        fi

        LTS_REPO_PATH=$(pwd)
        # (cd $(basename ${GERRIT_PROJECT}); git log --oneline -n5)
        cd -

        python3 tf-a-ci-scripts/lts/lts-triage.py --repo $LTS_REPO_PATH --email_path $START_PATH/email.txt --debug

        cd $START_PATH
        rm -rf $LTS_TMP_DIR
    publishers:
        - conditional-publisher:
          - condition-kind: file-exists
            on-evaluation-failure: dont-run
            condition-filename: email.txt
            condition-basedir: workspace
            action:
            - email-ext:
                always: true
                subject: "TF-A LTS Triage Email"
                body: '${FILE, path="email.txt"}'
                recipients: okash@google.com, bipin.ravi@arm.com, vwadekar@nvidia.com, joanna.farley@arm.com, lauren.wehrmeister@arm.com palmer@google.com
