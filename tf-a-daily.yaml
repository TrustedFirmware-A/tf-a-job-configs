- job:
    name: "tf-a-daily"
    node: "docker-amd64-tf-a-jammy"
    project-type: "freestyle"
    concurrent: false
    disabled: false
    description: "Triggers tf-a-windows-builder, tf-main and tf-coverity for the TF-A project."

    properties:
      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a"

      - build-discarder:
          days-to-keep: 14
          num-to-keep: 60

    parameters:
      - tf-a-clone:
          projects: "trusted-firmware-a,tf-a-ci-scripts,tf-a-tests,tf-m-extras,tf-m-tests,tf-rmm,spm"

      - string:
          name: "TF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "TF_GERRIT_BRANCH"
          default: "integration"

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "integration"

      - string:
          name: "TFTF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/tf-a-tests"

      - string:
          name: "TFTF_GERRIT_BRANCH"
          default: "master"

      - string:
          name: "TFTF_GERRIT_REFSPEC"
          default: "master"

      - string:
          name: "SPM_REFSPEC"
          default: "master"

          description: |
            SPM(Hafnium) refspec to use. The master branch is used by default.

      - string:
          name: "RMM_REFSPEC"
          default: "main"

          description: |
            tf-rmm refspec to use. The main branch is used by default.

      - string:
          name: "CI_REFSPEC"
          default: "master"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "MBEDTLS_URL"
          default: "https://github.com/Mbed-TLS/mbedtls/archive/mbedtls-3.6.5.tar.gz"

      - string:
          name: "LAVA_PRIORITY"
          default: "low"

    wrappers:
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - "timestamps"

    builders:
      - "tf-a-clone"

      - shell: |
          #!/bin/bash
          set -e

      - trigger-builds:
          - project:
              - "tf-a-main"

            block: true
            current-parameters: true

          - project:
              - "tf-a-coverity"

            block: true
            current-parameters: true

          - project:
              - "tf-a-windows-builder"

            block: true
            current-parameters: true

      # If all tests passed, catch up the master branch with integration
      - conditional-step:
          condition-kind: "current-status"
          condition-best: "SUCCESS"
          condition-worst: "SUCCESS"

          steps:
            - shell: |-
                #!/bin/bash
                echo "Proceed with integration->master fast-forward merge"
                bash "${{WORKSPACE}}/tf-a-ci-scripts/script/scratch_scripts/fast-forward-master.sh"

    triggers:
      - timed: "H 22 * * *"
