- job:
    name: "tf-a-lts2.14-builder"
    node: "docker-amd64-tf-a-lts2.14-jammy"
    project-type: "freestyle"
    concurrent: true
    disabled: false

    description: |
      Trusted Firmware A (TF-A) LTS 2.14 builder

    properties:
      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a-lts-v2.14"

      - build-discarder:
          days-to-keep: 30

    parameters:
      - tf-a-clone-parameters:
          projects: "trusted-firmware-a,tf-a-ci-scripts,tf-a-tests,tf-m-extras,tf-m-tests,tf-rmm,spm"

      - string:
          name: "TEST_CONFIG"

          description: |
            Original test configuration.

      - string:
          name: "TEST_DESC"

          description: |
            Expanded and normalized test configuration, aka "test description"

      - string:
          name: "GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "GERRIT_BRANCH"
          default: "lts-v2.14"

      - string:
          name: "GERRIT_REFSPEC"
          default: "lts-v2.14"

      - string:
          name: "TF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "lts-v2.14"

      - string:
          name: "RF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

      - string:
          name: "RFA_REFSPEC"
          default: "main"

          description: |
            rusted-firmware-a refspec to use. The main branch is used by default.

      - string:
          name: "TFTF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/tf-a-tests"

      - string:
          name: "TFTF_GERRIT_REFSPEC"
          default: "lts-v2.14"

      - string:
          name: "TF_M_TESTS_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-M/tf-m-tests"

      - string:
          name: "TF_M_TESTS_GERRIT_REFSPEC"
          default: "3041b858639c85d9541c37fcbd1b42d3d0f03c79"

      - string:
          name: "TF_M_EXTRAS_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-M/tf-m-extras"

      - string:
          name: "TF_M_EXTRAS_GERRIT_REFSPEC"
          default: "6edb83b21cae8ebbc3c3c219ea34d41ca0cc2bf1"

      - string:
          name: "SPM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}hafnium/hafnium"

      - string:
          name: "SPM_REFSPEC"
          default: "lts-v2.14"

          description: |
            SPM(Hafnium) refspec to use. The lts-v2.14 branch is used by default.

      - string:
          name: "RMM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-RMM/tf-rmm"

      - string:
          name: "RMM_REFSPEC"
          default: "tf-rmm-v0.8.0"

      - string:
          name: "CI_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-ci-scripts"

      - string:
          name: "CI_REFSPEC"
          default: "lts-v2.14"

      - string:
          name: "JOBS_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-job-configs.git"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "JUNO_ROOTFS_URL"
          default: "https://downloads.trustedfirmware.org/infra-assets/linaro_artifacts/releases/openembedded/aarch64/17.01/linaro-image-minimal-genericarmv8-20170127-888.rootfs.tar.gz"

      - string:
          name: "MBEDTLS_URL"
          default: "https://github.com/Mbed-TLS/mbedtls/archive/mbedtls-3.6.5.tar.gz"

      - string:
          name: "DOCKER_REGISTRY"
          default: "${{PRIVATE_CONTAINER_REGISTRY}}"
          description: "PRIVATE_CONTAINER_REGISTRY is a system-wide environment variable"

      - string:
          name: "QA_TOOLS_REPO"
          default: "https://git.gitlab.arm.com/tooling/qa-tools.git"

      - string:
          name: "QA_TOOLS_BRANCH"
          default: "master"

      - string:
          name: "LAVA_RETRIES"
          default: 2

          description: |
            Number of tries submitting job to LAVA in case it fails (stopgap measure against nondeterministic failures)

      - string:
          name: "USE_TUXSUITE_FVP"
          default: 1

          description: |
            Whether to submit FVP tests via TuxSuite (instead of LAVA)

    wrappers:
      - "timestamps"

      - timeout:
          timeout: 120
          fail: true

      - credentials-binding:
          - text:
              credential-id: "LAVA_USER_TF"
              variable: "LAVA_USER"

      - credentials-binding:
          - text:
              credential-id: "LAVA_TOKEN_TF"
              variable: "LAVA_TOKEN"

      - credentials-binding:
          - text:
              credential-id: "TUXSUITE_TOKEN"
              variable: "TUXSUITE_TOKEN"

      - credentials-binding:
          - file:
              credential-id: "ARMCLANG_UBL_FILE"
              variable: "ARMCLANG_UBL_FILE"

      - inject:
          properties-content: |
            BUILDERS_SH_ARMCLANG_VERSION=6.23
            BUILDERS_SH_ARMCLANG_WAREHOUSE_VERSION=6.23/37

    builders:
      - shell: |
          aarch64-none-elf-gcc -v || true

      - tf-a-clone:
          projects: "${{CLONE_REPOS}}"

      - shell: !include-raw-verbatim: "tf-a-builder/builders.sh"

      - inject:
          properties-file: "artefacts/env"

      - shell: |
          ln -s "artefacts/${{BIN_MODE:-release}}" "artefacts-lava"
          echo ${{BIN_MODE:-release}} >lava-binmode.txt

      - conditional-step:
          condition-kind: "file-exists"
          on-evaluation-failure: "dont-run"
          condition-filename: "artefacts-lava/job.yaml"
          condition-basedir: "workspace"

          steps:
            - shell: |
                #!/bin/bash
                set -e
                DEVICE_TYPE=fvp
                CUSTOM_YAML_URL=${{BUILD_URL}}/artifact/artefacts-lava/job.yaml
                DEVICE_TYPE=$(awk -F': ' '/device_type/ {{print $2}}' ${{WORKSPACE}}/artefacts-lava/job.yaml)
                cat << EOF > ${{WORKSPACE}}/lava.param
                DEVICE_TYPE=${{DEVICE_TYPE}}
                LAVA_SERVER=tf.validation.linaro.org
                EOF

    publishers:
      - archive:
          artifacts: "artefacts/**, lava-binmode.txt"
          latest-only: false
          allow-empty: true
          follow-symlinks: true

      - conditional-publisher:
          - condition-kind: "file-exists"
            on-evaluation-failure: "dont-run"
            condition-filename: "artefacts-lava/job.yaml"
            condition-basedir: "workspace"

            action:
              - postbuildscript:
                  mark-unstable-if-failed: true

                  builders:
                    - role: "SLAVE"

                      build-on:
                        - "SUCCESS"

                      build-steps:
                        - inject:
                            properties-file: "${{WORKSPACE}}/lava.param"

                        - shell: |
                            #!/bin/bash -x

                            tf-a-job-configs/tf-a-builder/submit-test-job.sh
                            status=$?
                            tf-a-job-configs/tf-a-builder/lava-log-process.sh
                            if [ $status -ne 0 ]; then
                                echo "LAVA JOB RESULT: 1"
                                exit 1
                            else
                                echo "LAVA JOB RESULT: 0"
                            fi

              - postbuildscript:
                  builders:
                    - role: "SLAVE"

                      build-on:
                        - "SUCCESS"

                      build-steps:
                        - shell: |
                            #!/bin/bash -e
                            echo "=== Starting expect-post tests ==="
                            ./tf-a-ci-scripts/script/expect-post-runner.sh

      - conditional-publisher:
          - condition-kind: "file-exists"
            on-evaluation-failure: "dont-run"
            condition-filename: "artefacts/release/tfut_artefacts.txt"
            condition-basedir: "workspace"

            action:
              - postbuildscript:
                  builders:
                    - role: "SLAVE"

                      build-on:
                        - "SUCCESS"

                      build-steps:
                        - shell: |
                            #!/bin/bash -e
                            echo "Found unit test executables, running unit tests now"
                            export workspace="$(pwd)"
                            export tfut_root="$(pwd)/tf-a-unit-tests"
                            bash -x "$workspace/tf-a-ci-scripts/script/run_unit_tests.sh"

      - conditional-publisher:
          - condition-kind: "file-exists"
            on-evaluation-failure: "dont-run"
            condition-filename: "lava-raw-debug.log"
            condition-basedir: "workspace"

            action:
              - archive:
                  artifacts: "lava-raw-debug.log"
                  latest-only: false
                  allow-empty: true

      - conditional-publisher:
          - condition-kind: "file-exists"
            on-evaluation-failure: "dont-run"
            condition-filename: "unit_tests/run/run.sh"
            condition-basedir: "workspace"

            action:
              - archive:
                  artifacts: "unit_tests/**"
                  latest-only: false
                  allow-empty: true

      - archive:
          artifacts: "lava.log, lava-*.log, tux.id, feedback.log, config_file.json, covtrace-*.log, trace_report/**"
          latest-only: false
          allow-empty: true

      - groovy-postbuild:
          script: !include-raw-verbatim:
            - "tf-a-builder/postbuild.groovy"
