- job:
    name: tf-a-weekly
    node: docker-amd64-tf-a-jammy
    project-type: multijob
    concurrent: true
    disabled: false
    description: Main CI job for Trusted Firmware.
    properties:
      - throttle:
          option: project
          enabled: true
          max-total: 5
      - build-discarder:
          days-to-keep: 14
          num-to-keep: 60
    parameters:
      - string:
          name: TF_GERRIT_PROJECT
          default: TF-A/trusted-firmware-a
      - string:
          name: TF_GERRIT_BRANCH
          default: refs/heads/integration
      - string:
          name: TF_GERRIT_REFSPEC
          default: +refs/heads/integration:refs/remotes/origin/integration
      - string:
          name: TFTF_GERRIT_PROJECT
          default: TF-A/tf-a-tests
      - string:
          name: TFTF_GERRIT_BRANCH
          default: refs/heads/master
      - string:
          name: TFTF_GERRIT_REFSPEC
          default: +refs/heads/master:refs/remotes/origin/master
      - string:
          name: SPM_REFSPEC
          default: +refs/heads/master:refs/remotes/origin/master
          description: |
            SPM(Hafnium) refspec to use. The master branch is used by default.
      - string:
          name: RMM_REFSPEC
          default: +refs/heads/main:refs/remotes/origin/main
          description: |
            tf-rmm refspec to use. The main branch is used by default.
      - string:
          name: CI_REFSPEC
          default: +refs/heads/master:refs/remotes/origin/master
      - string:
          name: JOBS_REFSPEC
          default: refs/heads/master
          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.
      - string:
          name: LAVA_PRIORITY
          default: low
      - string:
          name: MBEDTLS_URL
          default: https://github.com/Mbed-TLS/mbedtls/archive/mbedtls-3.6.5.tar.gz
      - string:
          name: LAVA_RETRIES
          default: 2
          description: |
            Number of tries submitting job to LAVA in case it fails (stopgap measure against nondeterministic failures)
      - string:
          name: USE_TUXSUITE_FVP
          default: 1
          description: |
            Whether to submit FVP tests via TuxSuite (instead of LAVA)
    wrappers:
      - timestamps
    builders:
      - shell: !include-raw: scripts/clone.sh
      - shell: |
          #!/bin/bash
          set -e
          cat << EOF > tf-a-env.param
          GERRIT_PROJECT=${TF_GERRIT_PROJECT}
          GERRIT_BRANCH=${TF_GERRIT_BRANCH}
          GERRIT_REFSPEC=${TF_GERRIT_REFSPEC}
          EOF
          cat << EOF > tf-a-tests-env.param
          GERRIT_PROJECT=${TFTF_GERRIT_PROJECT}
          GERRIT_BRANCH=${TFTF_GERRIT_BRANCH}
          GERRIT_REFSPEC=${TFTF_GERRIT_REFSPEC}
          EOF
      - multijob:
          name: TFTF Fuzzing
          condition: COMPLETED
          projects:
            - name: tf-a-ci-gateway
              alias: tf-l3-fuzzing SDEI
              current-parameters: true
              kill-phase-on: NEVER
              predefined-parameters: TEST_GROUPS=tf-l3-fuzzing
              property-file: tf-a-tests-env.param
      - multijob:
          name: TFTF Fuzzing FFA
          condition: COMPLETED
          projects:
            - name: tf-a-ci-gateway
              alias: tf-l3-fuzzing FFA
              current-parameters: true
              kill-phase-on: NEVER
              predefined-parameters: TEST_GROUPS=tf-l3-fuzzing-ffa
              property-file: tf-a-tests-env.param
      # participate in the job's success/failure.
      - trigger-builds:
          - project: tf-a-ci-coverage-gateway
            block: true
            current-parameters: true
    triggers:
      - timed: 59 23 * * 7
