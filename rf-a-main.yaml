- job:
    name: "rf-a-main"
    node: "docker-amd64-tf-a-jammy"
    project-type: "multijob"
    concurrent: true
    disabled: false
    description: "Main CI job for Rusted Firmware A"

    properties:
      - throttle:
          option: "project"
          enabled: true
          max-total: 5

      - build-discarder:
          days-to-keep: 14
          num-to-keep: 60

    triggers:
      - gerrit:
          server-name: "review.trustedfirmware.org"

          projects:
            - branches:
                - branch-compare-type: "PLAIN"
                  branch-pattern: "main"

              project-compare-type: "PLAIN"
              project-pattern: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

          trigger-on:
            - patchset-created-event:
                exclude-drafts: true
                exclude-trivial-rebase: true
                exclude-no-code-change: true
                exclude-private: true
                exclude-wip: true

            - comment-added-contains-event:
                comment-contains-value: "^RUN_CI$"

          override-votes: true
          gerrit-build-started-verified-value: 0
          gerrit-build-successful-verified-value: 1
          gerrit-build-failed-verified-value: -1
          gerrit-build-unstable-verified-value: -1
          gerrit-build-notbuilt-verified-value: 0
          # without explicitly setting these values to 0, the plugin will by
          # default leave Code Review votes
          gerrit-build-started-codereview-value: 0
          gerrit-build-successful-codereview-value: 0
          gerrit-build-failed-codereview-value: 0
          gerrit-build-unstable-codereview-value: 0
          gerrit-build-notbuilt-codereview-value: 0
          silent: false
          silent-start: false

    parameters:
      # GERRIT_{PROJECT,BRANCH,REFSPEC} are set when triggered by a Gerrit
      # patchset - defaults below are for manual triggers
      - string:
          name: "GERRIT_PROJECT"
          default: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

      - string:
          name: "GERRIT_BRANCH"
          default: "main"

      - string:
          name: "GERRIT_REFSPEC"
          default: "main"

          description: |
            'e.g. refs/changes/13/31138/1'

      - string:
          name: "RFA_REFSPEC"
          default: "${{GERRIT_REFSPEC}}"

          description: |
            'do-not-amend: used by scripts/clone.sh to fetch the correct Gerrit patchset - use GERRIT_REFSPEC instead'

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "master"

          description: |
            'Used by scripts/clone.sh to fetch the correct Gerrit patchset'

      - string:
          name: "CI_REFSPEC"
          default: "master"

          description: |
            'Refs to fetch for the tf-a-ci-scripts repo e.g. refs/changes/13/31138/1'

      - string:
          name: "JOBS_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-job-configs.git"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "CLONE_REPOS"
          default: "tf-a-job-configs,tf-a-ci-scripts,trusted-firmware-a,rusted-firmware-a"

          description: |
            Optional arg to clone only specific projects from default list (tf-a-ci-scripts,trusted-firmware-a,tf-a-tests,spm,tf-m-tests,tf-m-extras)

    wrappers:
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - "timestamps"

    builders:
      - shell: !include-raw-verbatim: "scripts/clone.sh"

      - shell: |
          #!/bin/bash
          set -e
          cat << EOF > tf-a-env.param
          RF_GERRIT_PROJECT=${{GERRIT_PROJECT}}
          RFA_REFSPEC=${{RFA_REFSPEC}}
          GERRIT_REFSPEC=${{GERRIT_REFSPEC}}
          GERRIT_BRANCH=${{GERRIT_BRANCH}}
          TF_GERRIT_PROJECT=${{GERRIT_PROJECT_PREFIX:-}}TF-A/trusted-firmware-a
          TF_GERRIT_REFSPEC=${{TF_GERRIT_REFSPEC}}
          EOF

      - multijob:
          name: "Lint commit messages"
          condition: "COMPLETED"

          projects:
            - name: "rf-a-commitlint"
              kill-phase-on: "NEVER"

              predefined-parameters: |
                REFSPEC=${{GERRIT_REFSPEC}}
                REFNAME=${{GERRIT_PATCHSET_REVISION}}
                REFNAME_BASE=origin/${{GERRIT_BRANCH}}

      - multijob:
          name: "Code formatting, static checks and lints"
          condition: "COMPLETED"

          projects:
            - name: "rf-a-static"
              current-parameters: true
              kill-phase-on: "NEVER"

              predefined-parameters: |
                GERRIT_BRANCH=${{GERRIT_BRANCH}}
                RFA_REFSPEC=${{RFA_REFSPEC}}
                GERRIT_REFSPEC=${{GERRIT_REFSPEC}}

              property-file: "tf-a-env.param"

      - multijob:
          name: "Platform independent tests"
          condition: "COMPLETED"

          projects:
            - name: "generic-lib-testing"
              current-parameters: true
              kill-phase-on: "NEVER"

              predefined-parameters: |
                TEST_REPO_NAME=rusted-firmware-a
                TEST_REPO_PROJECT=RF-A
                RFA_REFSPEC=$RFA_REFSPEC
                GERRIT_REFSPEC=${{GERRIT_REFSPEC}}

              property-file: "tf-a-env.param"

      - multijob:
          name: "Build Rusted Firmware A"
          condition: "COMPLETED"

          projects:
            - name: "rf-a-ci-gateway"
              alias: "rfa-build"
              current-parameters: true
              kill-phase-on: "NEVER"

              predefined-parameters: |
                TEST_GROUPS=rfa-build
                RFA_REFSPEC=$RFA_REFSPEC

              property-file: "tf-a-env.param"

      - multijob:
          name: "FVP Tests"
          condition: "COMPLETED"

          projects:
            - name: "rf-a-ci-gateway"
              alias: "rfa-fvp"
              current-parameters: true
              kill-phase-on: "NEVER"

              predefined-parameters: |
                TEST_GROUPS=rfa-fvp
                RFA_REFSPEC=$RFA_REFSPEC

              property-file: "tf-a-env.param"
