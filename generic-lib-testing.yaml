- job:
    name: "generic-lib-testing"
    node: "docker-amd64-tf-a-jammy"
    project-type: "freestyle"
    concurrent: true
    disabled: false
    description: "Run platform independent tests"

    properties:
      - build-discarder:
          days-to-keep: 14

    parameters:
      - string:
          name: "RF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

      - string:
          name: "RFA_REFSPEC"
          default: "main"

      - string:
          name: "CI_REFSPEC"
          default: "rf-a"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "GERRIT_BRANCH"
          default: "main"

      - string:
          name: "CLONE_REPOS"
          default: "tf-a-ci-scripts,rusted-firmware-a"

          description: |
            Optional arg to clone only specific projects from default list (tf-a-ci-scripts,trusted-firmware-a,tf-a-tests,spm,tf-m-tests,tf-m-extras,etc.)

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - string:
          name: "TEST_REPO_PROJECT"
          default: "arm-firmware-crates"
          description: "Name of the project where the remote repository is located."

      - string:
          name: "TEST_REPO_NAME"
          description: "Name of the remote repository where the tests should be triggered."

      - string:
          name: "TEST_FEATURES"
          description: "Features against which the library will be tested"

    wrappers:
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - "timestamps"

      - timeout:
          timeout: 240
          fail: true

    builders:
      - shell: !include-raw-verbatim: "scripts/clone.sh"

      - shell: |
          #!/bin/bash
          set -e
          cat << EOF > env.param
          GERRIT_PROJECT=${{RF_GERRIT_PROJECT}}
          GERRIT_BRANCH=${{GERRIT_BRANCH}}
          GERRIT_REFSPEC=${{RFA_REFSPEC}}
          EOF

          cd ${{WORKSPACE}}
          # Executed project-related next checks: platform independent tests with a generic platform.
          IS_CONTINUOUS_INTEGRATION=1 ${{WORKSPACE}}/tf-a-ci-scripts/script/next-checks/next-checks-generic-tests.sh \
            ${{TEST_REPO_PROJECT}} ${{TEST_REPO_NAME}}

    publishers:
      - archive:
          artifacts: "next-generic-checks.log"

      - groovy-postbuild:
          script: !include-raw-verbatim:
            - "generic-lib-testing/postbuild.groovy"
