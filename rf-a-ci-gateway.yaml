- job:
    name: "rf-a-ci-gateway"
    node: "docker-amd64-tf-a-jammy"
    project-type: "freestyle"
    concurrent: true
    disabled: false

    description: |
      Main job entry point for a Rusted Firmware A (RF-A) CI

    properties:
      - tf-a-ci-scripts:
          download_server_url: "https://downloads.trustedfirmware.org"
          download_server_tf_a_url: "https://downloads.trustedfirmware.org/tf-a"

      - build-discarder:
          days-to-keep: 15

      - throttle:
          option: "project"
          enabled: true
          max-per-node: 3
          max-total: 10

    wrappers:
      - credentials-binding:
          - ssh-user-private-key:
              credential-id: "TFA_CI_BOT_USER_SSH_KEY"
              key-file-variable: "CI_BOT_KEY"
              username-variable: "CI_BOT_USERNAME"
              passphrase-variable: ""

      - timeout:
          timeout: 240
          fail: true

      - "timestamps"

    parameters:
      - tf-a-clone-parameters:
          projects: "tf-a-ci-scripts,trusted-firmware-a,rusted-firmware-a"

      - string:
          name: "GERRIT_PROJECT"
          default: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

      - string:
          name: "GERRIT_REFSPEC"
          default: "main"

      - string:
          name: "TEST_GROUPS"
          default: "rfa-fvp/fvp,nil,fvp-rfa:fvp-rfa-fip.rfa"

          description: |
            White space separated list of test configs: can be mix of specific
            test configs (e.g., <code>l1/fvp-default:fvp-linux-default</code>) and
            group names (e.g., <code>l1 l2</code>).

      - string:
          name: "RF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}RF-A/rusted-firmware-a"

      - string:
          name: "RFA_REFSPEC"
          default: "main"

          description: |
            rusted-firmware-a refspec to use. The main branch is used by default.

      - string:
          name: "TF_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-A/trusted-firmware-a"

      - string:
          name: "TF_GERRIT_REFSPEC"
          default: "master"

          description: |
            trusted-firmware-a refspec to use. The master branch is used by default.

      - string:
          name: "SPM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}hafnium/hafnium"

      - string:
          name: "SPM_REFSPEC"
          default: "master"

          description: |
            SPM(Hafnium) refspec to use. The master branch is used by default.

      - string:
          name: "RMM_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}TF-RMM/tf-rmm"

      - string:
          name: "RMM_REFSPEC"
          default: "main"

          description: |
            tf-rmm refspec to use. The main branch is used by default.

      - string:
          name: "CI_GERRIT_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-ci-scripts"

      - string:
          name: "CI_REFSPEC"
          default: "master"

          description: |
            tf-a-ci-scripts refspec to use. The rf-a branch is used by default.

      - string:
          name: "JOBS_PROJECT"
          default: "{gerrit_project_prefix}ci/tf-a-job-configs.git"

      - string:
          name: "JOBS_REFSPEC"
          default: "master"

          description: |
            tf-a-job-configs refspec to use. The master branch is used by default.

      - bool:
          name: "ENABLE_STATIC_CHECK"
          default: false

      - string:
          name: "QA_TOOLS_REPO"
          default: "https://git.gitlab.arm.com/tooling/qa-tools.git"

      - string:
          name: "QA_TOOLS_BRANCH"
          default: "master"

    scm:
      - git:
          url: "ssh://review.trustedfirmware.org:29418/ci/tf-a-ci-scripts"
          credentials-id: "TFA_CI_BOT_USER_SSH_KEY"
          basedir: "tf-a-ci-scripts"

          refspec: "${{CI_REFSPEC}}:${{CI_REFSPEC}}"
          branches: ["${{CI_REFSPEC}}"]

          changelog-against:
            branch: "master"

          extensions:
            - honor-refspec: true

    builders:
      - shell: |
          #!/bin/bash
          set -e
          CI_ROOT=${{PWD}}/tf-a-ci-scripts
          export workspace=$PWD
          export test_groups=$TEST_GROUPS
          $CI_ROOT/script/gen_test_desc.py

      - trigger-builds:
          - project:
              - "rf-a-builder"

            block: true
            current-parameters: true

            predefined-parameters: |
                CLONE_REPOS=${{CLONE_REPOS}}

            parameter-factories:
              - factory: "filebuild"
                file-pattern: "*.testprop"
                no-files-found-action: "FAIL"

    publishers:
      - postbuildscript:
          builders:
            - role: "SLAVE"

              build-on:
                - "SUCCESS"
                - "FAILURE"
                - "UNSTABLE"
                - "ABORTED"
                - "NOT_BUILT"

              build-steps:
                - shell: |-
                    #!/bin/bash -e
                    export CI_ROOT=${{PWD}}/tf-a-ci-scripts
                    bash "$CI_ROOT/job/tf-ci-gateway/generate_report.sh"

      - archive:
          artifacts: "report.json, report.html, merge/outdir/**"

      - groovy-postbuild:
          script: !include-raw-verbatim:
            - "tf-a-ci-gateway/postbuild.groovy"
